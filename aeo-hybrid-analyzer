<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEO Hybrid Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 240px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -120px; opacity: 0; transition: opacity 0.3s; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        #text-input { min-height: 250px; cursor: text; }
        #tag-toolbar { position: absolute; display: none; background-color: #1f2937; border-radius: 6px; padding: 4px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #tag-toolbar button { background: transparent; border: none; color: white; padding: 6px 10px; border-radius: 4px; font-size: 14px; cursor: pointer; }
        #tag-toolbar button:hover { background-color: #4a5568; }
        [data-tag] { padding: 2px 0; }
        [data-tag="h1"] { background-color: rgba(239, 68, 68, 0.2); font-weight: bold; }
        [data-tag="h2"] { background-color: rgba(249, 115, 22, 0.2); font-weight: bold; }
        [data-tag="h3"] { background-color: rgba(234, 179, 8, 0.2); font-weight: bold; }
        [data-tag="h4"] { background-color: rgba(59, 130, 246, 0.2); font-weight: bold; }
        [data-tag="h5"] { background-color: rgba(139, 92, 246, 0.2); font-weight: bold; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="tag-toolbar">
        <button data-tag="h1">H1</button><button data-tag="h2">H2</button><button data-tag="h3">H3</button><button data-tag="h4">H4</button><button data-tag="h5">H5</button>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-slate-900 mb-2">AEO Hybrid Analyzer</h1>
            <p class="text-slate-500 max-w-2xl mx-auto">
                Upload your pre-analyzed JSON data for quantifiable results, and add content to get a qualitative Gemini analysis grounded in your data.
            </p>
        </header>

        <main id="input-section" class="bg-white rounded-lg shadow-2xl p-6 md:p-8">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label for="page-title-input" class="block text-lg font-medium text-slate-900 mb-2">Page Title <span class="text-sm text-slate-400">(Optional)</span></label>
                    <input type="text" id="page-title-input" class="w-full p-3 bg-slate-100 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none transition">
                </div>
                <div>
                    <label for="meta-desc-input" class="block text-lg font-medium text-slate-900 mb-2">Meta Description <span class="text-sm text-slate-400">(Optional)</span></label>
                    <input type="text" id="meta-desc-input" class="w-full p-3 bg-slate-100 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none transition">
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-lg font-medium text-slate-900 mb-2">Content Body</label>
                <div id="text-input" contenteditable="true" class="w-full p-3 bg-slate-100 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none transition prose max-w-none"></div>
            </div>
             <div class="mb-6 bg-indigo-50 border-2 border-dashed border-indigo-200 rounded-lg p-4 text-center">
                 <label for="json-upload" class="block text-lg font-medium text-slate-900 mb-2">Upload Analysis JSON</label>
                 <p class="text-sm text-slate-500 mb-2">Upload your Colab/NLP API JSON file to ground the analysis with quantifiable data.</p>
                 <input type="file" id="json-upload-input" accept=".json" class="hidden">
                 <button id="json-upload-btn" class="bg-indigo-200 hover:bg-indigo-300 text-indigo-800 font-bold py-2 px-4 rounded-md transition duration-300">
                     Select .json File
                 </button>
                 <span id="json-file-name" class="ml-3 text-slate-600">No file selected.</span>
             </div>
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <button id="analyze-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
                    Analyze
                </button>
                 <button id="reset-btn" class="w-full sm:w-auto bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center gap-2">
                    Reset
                </button>
            </div>
        </main>
        
        <div id="results-section" class="mt-8 hidden">
            <div class="flex justify-end gap-4 mb-4">
                 <button id="export-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-md transition duration-300">Copy Results to Clipboard</button>
                 <button id="new-analysis-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-md transition duration-300">Start New Analysis</button>
            </div>
            <div id="loading-indicator" class="text-center p-8 hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
                <p class="mt-4 text-slate-500">Analyzing content...</p>
            </div>
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md my-4">
                <strong class="font-bold">Error:</strong>
                <span id="error-text" class="block sm:inline"></span>
            </div>
            <div id="analysis-output" class="hidden grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-3 bg-white rounded-lg shadow-2xl p-6 md:p-8">
                     <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-slate-900">Analyzed Text</h2>
                        <div class="tooltip">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                            <span class="tooltiptext text-sm !text-left">Highlighting is based on the `unique_mentions_list` from the JSON, which groups variants (e.g., 'Toronto', 'the city') under one canonical entity name.</span>
                        </div>
                    </div>
                    <div id="highlighted-text" class="prose max-w-none text-slate-600 leading-relaxed whitespace-pre-wrap rounded-md bg-slate-100 p-4"></div>
                </div>
                <div class="lg:col-span-2 flex flex-col gap-8">
                    <div class="bg-white rounded-lg shadow-2xl p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">Analysis Overview</h2>
                        <div id="summary-analysis" class="space-y-3"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-2xl p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">Key Entities <span class="text-sm text-slate-400 font-normal">(from JSON)</span></h2>
                        <div id="entities-list" class="space-y-4 max-h-96 overflow-y-auto"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-2xl p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">Detected Topics <span class="text-sm text-slate-400 font-normal">(from JSON)</span></h2>
                        <div id="topics-list" class="space-y-3"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-2xl p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">Content Strength Analysis <span class="text-sm text-slate-400 font-normal">(Gemini API)</span></h2>
                        <div id="strength-analysis" class="space-y-4"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow-2xl p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4">Intent & Funnel <span class="text-sm text-slate-400 font-normal">(Gemini API)</span></h2>
                        <div id="intent-analysis" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State ---
            let quantifiedData = null;
            let qualitativeData = null;
            let analysisSummary = {};

            // --- DOM Selectors ---
            const inputSection = document.getElementById('input-section');
            const pageTitleInput = document.getElementById('page-title-input');
            const metaDescInput = document.getElementById('meta-desc-input');
            const textInput = document.getElementById('text-input');
            const analyzeBtn = document.getElementById('analyze-btn');
            const resetBtn = document.getElementById('reset-btn');
            const jsonUploadInput = document.getElementById('json-upload-input');
            const jsonUploadBtn = document.getElementById('json-upload-btn');
            const jsonFileName = document.getElementById('json-file-name');
            const tagToolbar = document.getElementById('tag-toolbar');
            const newAnalysisBtn = document.getElementById('new-analysis-btn');
            const exportBtn = document.getElementById('export-btn');
            const resultsSection = document.getElementById('results-section');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const analysisOutput = document.getElementById('analysis-output');
            const highlightedText = document.getElementById('highlighted-text');
            const summaryAnalysisDiv = document.getElementById('summary-analysis');
            const strengthAnalysisDiv = document.getElementById('strength-analysis');
            const entitiesList = document.getElementById('entities-list');
            const topicsList = document.getElementById('topics-list');
            const intentAnalysisDiv = document.getElementById('intent-analysis');
            
            // --- Event Listeners ---
            jsonUploadBtn.addEventListener('click', () => jsonUploadInput.click());
            jsonUploadInput.addEventListener('change', handleJsonUpload);
            analyzeBtn.addEventListener('click', handleAnalyze);
            resetBtn.addEventListener('click', handleReset);
            newAnalysisBtn.addEventListener('click', handleReset);
            exportBtn.addEventListener('click', exportResults);
            textInput.addEventListener('mouseup', showTagToolbar);
            textInput.addEventListener('keyup', showTagToolbar);
            document.addEventListener('mousedown', (e) => { if (!tagToolbar.contains(e.target) && !textInput.contains(e.target)) { tagToolbar.style.display = 'none'; } });
            tagToolbar.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { const tag = e.target.dataset.tag; document.execCommand('insertHTML', false, `<span data-tag="${tag}">${document.getSelection().toString()}</span>`); tagToolbar.style.display = 'none'; textInput.focus(); } });

            // --- Paste Sanitizer ---
            textInput.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                document.execCommand('insertText', false, text);
            });

            // --- Core Functions ---
            function handleReset() {
                pageTitleInput.value = ''; metaDescInput.value = ''; textInput.innerHTML = '';
                jsonUploadInput.value = ''; jsonFileName.textContent = 'No file selected.';
                inputSection.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                const resultFields = [highlightedText, summaryAnalysisDiv, strengthAnalysisDiv, entitiesList, topicsList, intentAnalysisDiv];
                resultFields.forEach(field => field.innerHTML = '');
                errorMessage.classList.add('hidden');
                quantifiedData = null; qualitativeData = null; analysisSummary = {};
            }

            function handleJsonUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                jsonFileName.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        quantifiedData = parsed.analysis && parsed.analysis[0] ? parsed.analysis[0] : parsed;
                    } catch (err) {
                        alert('Error parsing JSON file. Please ensure it is valid.');
                        quantifiedData = null;
                        jsonFileName.textContent = 'Invalid JSON file.';
                    }
                };
                reader.readAsText(file);
            }

            async function handleAnalyze() {
                const structuredTextForPrompt = getTextFromEditor(true);
                const plainTextForHighlighting = getTextFromEditor(false);

                if (!plainTextForHighlighting && !pageTitleInput.value && !metaDescInput.value) { alert('Please enter some content to analyze.'); return; }
                if (!quantifiedData) { alert('Please upload your analysis JSON file to proceed.'); return; }
                
                inputSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                analysisOutput.classList.add('hidden');
                errorMessage.classList.add('hidden');
                loadingIndicator.classList.remove('hidden');
                analyzeBtn.disabled = true;
                
                try {
                    qualitativeData = await callGeminiApi(structuredTextForPrompt, quantifiedData);
                    displayResults(quantifiedData, qualitativeData, plainTextForHighlighting);
                } catch (error) {
                    console.error('API Call Failed:', error);
                    errorText.textContent = `An error occurred: ${error.message}.`;
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    analyzeBtn.disabled = false;
                }
            }
            
            async function callGeminiApi(structuredText, groundTruthData) {
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const schema = {
                    type: "OBJECT",
                    properties: {
                        contentStrength: { type: "OBJECT", properties: { eeatSignals: { type: "OBJECT", properties: { rating: { type: "STRING" }, justification: { type: "STRING" } } }, actionability: { type: "OBJECT", properties: { rating: { type: "STRING" }, justification: { type: "STRING" } } }, clarity: { type: "OBJECT", properties: { rating: { type: "STRING" }, justification: { type: "STRING" } } }, depth: { type: "OBJECT", properties: { rating: { type: "STRING" }, justification: { type: "STRING" } } } } },
                        intentAnalysis: { type: "OBJECT", properties: { userIntent: { type: "STRING", enum: ["Informational", "Navigational", "Commercial", "Transactional"] }, funnelStage: { type: "STRING" } } }
                    },
                    required: ["contentStrength", "intentAnalysis"]
                };
                const groundTruthSummary = `Key Entities: ${(groundTruthData.detected_entities || []).map(e => e.name).slice(0, 15).join(', ')}\nKey Topics: ${(groundTruthData.detected_categories || []).map(c => c.name).join(', ')}`;

                let finalPromptText = "";
                if (pageTitleInput.value.trim()) { finalPromptText += `[PAGE_TITLE] ${pageTitleInput.value.trim()} [/]\n`; }
                if (metaDescInput.value.trim()) { finalPromptText += `[META_DESCRIPTION] ${metaDescInput.value.trim()} [/]\n`; }
                finalPromptText += structuredText;
                
                const prompt = `You are a tough, critical SEO strategist. GROUND TRUTH DATA: I have pre-analyzed the text with a trusted NLP model. This is the ground truth. ${groundTruthSummary}\n\nTASK: Based on the full content provided below AND the ground truth data above, perform a critical qualitative analysis. Provide insights in JSON format. 1. **contentStrength**: Analyze quality with a very critical eye. For each factor (eeatSignals, actionability, clarity, depth), provide a "rating" ("Poor", "Fair", "Good", "Excellent") and a "justification". Your justification MUST consider how well the text explores the ground truth entities and topics. 2. **intentAnalysis**: Identify the single primary "userIntent" and "funnelStage".\n\nFull Content:\n---\n${finalPromptText}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API request failed: ${response.statusText}`);
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("Invalid response from API.");
                return JSON.parse(jsonText);
            }
            
            function displayResults(quantData, qualData, plainText) {
                renderAnalysisSummary(quantData);
                renderContentStrength(qualData.contentStrength);
                renderIntent(qualData.intentAnalysis);
                renderEntities(quantData.detected_entities);
                renderTopics(quantData.detected_categories);
                renderHighlightedText(plainText, quantData.detected_entities);
                analysisOutput.classList.remove('hidden');
            }
            
            const ratingColors = { 'Excellent': 'bg-green-100 text-green-800', 'Good': 'bg-blue-100 text-blue-800', 'Fair': 'bg-yellow-100 text-yellow-800', 'Poor': 'bg-red-100 text-red-800' };
            const entityColors = { 'PERSON': 'bg-blue-500/30', 'ORGANIZATION': 'bg-green-500/30', 'LOCATION': 'bg-red-500/30', 'EVENT': 'bg-purple-500/30', 'WORK_OF_ART': 'bg-yellow-500/30', 'CONSUMER_GOOD': 'bg-pink-500/30', 'OTHER': 'bg-gray-500/30', 'PHONE_NUMBER': 'bg-teal-500/30', 'ADDRESS': 'bg-cyan-500/30', 'DATE': 'bg-orange-500/30', 'PRICE': 'bg-lime-500/30' };
            const defaultColor = 'bg-slate-500/30';
            function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
            function escapeHTML(str) { return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&#039;'); }
            
            function getTextFromEditor(isForPrompt = false) {
                const editor = document.getElementById('text-input');
                let result = '';
                const nodes = Array.from(editor.childNodes);

                for (let i = 0; i < nodes.length; i++) {
                    const node = nodes[i];
                    let textContent = '';

                    if (node.nodeType === 3) { // Text node
                        textContent = node.textContent;
                    } else if (node.nodeType === 1) { // Element node
                        if (isForPrompt && node.tagName === 'SPAN' && node.dataset.tag) {
                            const tag = node.dataset.tag.toUpperCase();
                            textContent = `[${tag}] ${node.textContent} [/]`;
                        } else {
                            textContent = node.textContent;
                        }
                    }
                    
                    result += textContent;

                    // Add a newline if the current node is a block element, and it's not the last one
                    if (i < nodes.length - 1 && node.nodeType === 1) {
                         const displayStyle = window.getComputedStyle(node).display;
                         if (displayStyle === 'block' || node.tagName === 'BR') {
                              if (!result.endsWith('\n')) {
                                  result += '\n';
                              }
                         }
                    }
                }
                return result.replace(/\n{3,}/g, '\n\n').trim();
            }

            // --- All other rendering and export functions remain the same ---

            function renderAnalysisSummary(quantData) {
                summaryAnalysisDiv.innerHTML = ''; if (!quantData) return;
                const topTopic = quantData.detected_categories && quantData.detected_categories.length > 0 ? quantData.detected_categories[0].name : 'N/A';
                const entities = (quantData.detected_entities || []).filter(e => e.salience > 0);
                const entityCount = entities.length;
                let avgTopSalience = 'N/A'; let topEntityDominance = 'N/A';
                if (entityCount > 0) {
                    const sortedEntities = [...entities].sort((a, b) => b.salience - a.salience);
                    const top10Entities = sortedEntities.slice(0, 10);
                    const top10SalienceSum = top10Entities.reduce((sum, entity) => sum + entity.salience, 0);
                    avgTopSalience = (top10SalienceSum / top10Entities.length).toFixed(2);
                    if (top10SalienceSum > 0) { topEntityDominance = `${((top10Entities[0].salience / top10SalienceSum) * 100).toFixed(0)}%`; }
                }
                analysisSummary = { topTopic, entityCount, avgTopSalience, topEntityDominance };
                summaryAnalysisDiv.innerHTML = ` <div class="flex justify-between items-center text-slate-600"><span class="font-semibold text-slate-800">Primary Topic:</span><span>${analysisSummary.topTopic}</span></div><div class="flex justify-between items-center text-slate-600"><span class="font-semibold text-slate-800">Unique Entities (Salience > 0):</span><span>${analysisSummary.entityCount}</span></div><div class="flex justify-between items-center text-slate-600"><span class="font-semibold text-slate-800">Avg. Salience (Top 10):</span><span>${analysisSummary.avgTopSalience}</span></div><div class="flex justify-between items-center text-slate-600"><div class="font-semibold text-slate-800 flex items-center"> Top Entity Dominance <div class="tooltip ml-2"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg> <span class="tooltiptext text-sm !text-left">This score shows how much the #1 entity's salience outweighs the rest of the top 10. <br><br><b>Calculation:</b><br> (Salience of #1) / (Sum of Top 10 Salience Scores)</span> </div></div><span>${analysisSummary.topEntityDominance}</span></div>`;
            }

            function renderEntities(entities) {
                if (!entities) { entitiesList.innerHTML = `<p class="text-slate-500">No entities found.</p>`; return; }
                entitiesList.innerHTML = '';
                entities.sort((a,b) => b.salience - a.salience).forEach(entity => {
                    const colorClass = entityColors[entity.type.toUpperCase()] ? entityColors[entity.type.toUpperCase()].replace('/30', '/50') : defaultColor.replace('/30','/50');
                    const wikiLink = entity.wikipedia_url ? `<a href="${entity.wikipedia_url}" target="_blank" class="ml-2 text-blue-500 hover:text-blue-700" title="View on Wikipedia"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></a>` : '';
                    const mentionCount = entity.total_mentions_count ?? (entity.unique_mentions_list || []).length;
                    
                    const entityElement = document.createElement('div');
                    entityElement.className = 'flex flex-col p-2 rounded-md hover:bg-slate-100';
                    entityElement.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-slate-800 flex items-center">${entity.name} ${wikiLink}</span>
                            <span class="text-xs font-mono px-2 py-1 rounded ${colorClass} text-slate-800">${entity.type}</span>
                        </div>
                        <div class="flex justify-between text-sm text-slate-500">
                            <span>Salience: <strong class="text-slate-700">${(entity.salience || 0).toFixed(2)}</strong></span>
                            <span>Mentions: <strong class="text-slate-700">${mentionCount}</strong></span>
                        </div>`;
                    entitiesList.appendChild(entityElement);
                });
            }

            function renderHighlightedText(text, entities) {
                if (!entities) { highlightedText.textContent = text; return; }
                const reps = [];
                const mentionsToHighlight = {};
                entities.forEach(ent => {
                    (ent.unique_mentions_list || [ent.name]).forEach(mentionStr => {
                         if (!mentionsToHighlight[mentionStr]) {
                            mentionsToHighlight[mentionStr] = { mention: mentionStr, type: ent.type, name: ent.name };
                        }
                    });
                });
                const sorted = Object.values(mentionsToHighlight).sort((a, b) => b.mention.length - a.mention.length);
                sorted.forEach(data => {
                    const regex = new RegExp(`\\b${escapeRegExp(data.mention)}\\b`, 'gi');
                    let match;
                    while ((match = regex.exec(text)) !== null) {
                        const start = match.index; const end = start + data.mention.length;
                        if (!reps.some(r => (start < r.end && end > r.start))) {
                            reps.push({ start, end, data });
                        }
                    }
                });
                reps.sort((a, b) => a.start - b.start);
                let last = 0;
                const parts = [];
                reps.forEach(({ start, end, data }) => {
                    if (start > last) { parts.push(escapeHTML(text.substring(last, start))); }
                    const color = entityColors[data.type.toUpperCase()] || defaultColor;
                    const tip = `Entity: ${data.name}\nType: ${data.type}\nMention: "${data.mention}"`;
                    parts.push(`<span class="tooltip rounded px-1 ${color}">${escapeHTML(text.substring(start, end))}<span class="tooltiptext whitespace-pre-wrap">${escapeHTML(tip)}</span></span>`);
                    last = end;
                });
                if (last < text.length) { parts.push(escapeHTML(text.substring(last))); }
                highlightedText.innerHTML = parts.join('');
            }

            function renderContentStrength(strengthData) { strengthAnalysisDiv.innerHTML = ''; if (!strengthData) return; const fields = [ { title: 'E-E-A-T Signals', data: strengthData.eeatSignals }, { title: 'Actionability', data: strengthData.actionability }, { title: 'Clarity & Readability', data: strengthData.clarity }, { title: 'Depth of Coverage', data: strengthData.depth } ]; fields.forEach(field => { const rating = field.data?.rating || 'N/A'; const just = field.data?.justification || 'No analysis.'; const color = ratingColors[rating] || 'bg-gray-100'; const el = document.createElement('div'); el.innerHTML = `<div class="flex justify-between items-center mb-1"><strong class="font-semibold text-slate-800">${field.title}</strong><span class="text-xs font-medium px-2 py-0.5 rounded-full ${color}">${rating}</span></div><p class="text-slate-600 text-sm">${just}</p>`; strengthAnalysisDiv.appendChild(el); }); }
            function showTagToolbar() { const sel = window.getSelection(); if (sel && !sel.isCollapsed) { const parent = sel.getRangeAt(0).commonAncestorContainer.parentNode; if(textInput.contains(parent)) { const range = sel.getRangeAt(0); const rect = range.getBoundingClientRect(); tagToolbar.style.display = 'block'; tagToolbar.style.left = `${rect.left+window.scrollX+(rect.width/2)-(tagToolbar.offsetWidth/2)}px`; tagToolbar.style.top = `${rect.top+window.scrollY-tagToolbar.offsetHeight-8}px`; } } else { tagToolbar.style.display = 'none'; } }
            function renderIntent(intentData) { intentAnalysisDiv.innerHTML = ''; if (!intentData) { intentAnalysisDiv.innerHTML = '<p>No intent analysis.</p>'; return; } intentAnalysisDiv.innerHTML = `<p><strong class="font-semibold">User Intent:</strong> ${intentData.userIntent || 'N/A'}</p><p><strong class="font-semibold">Funnel Stage:</strong> ${intentData.funnelStage || 'N/A'}</p>`; }
            function renderTopics(topics) { if (!topics) { topicsList.innerHTML = `<p>No topics found.</p>`; return; } topics.sort((a, b) => b.confidence - a.confidence); topicsList.innerHTML = ''; topics.forEach(topic => { const el = document.createElement('div'); el.innerHTML = `<div class="flex justify-between items-center text-sm mb-1"><span>${topic.name}</span><span class="font-mono">${(topic.confidence * 100).toFixed(1)}%</span></div><div class="w-full bg-slate-200 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${topic.confidence * 100}%"></div></div>`; topicsList.appendChild(el); }); }
            function exportResults() { if (!qualitativeData || !quantifiedData) { alert("No data to export."); return; } const { contentStrength } = qualitativeData; const { intentAnalysis } = qualitativeData; const { detected_entities } = quantifiedData; const { detected_categories } = quantifiedData; let report = `AEO ANALYSIS REPORT\n===================\n\n--- ANALYSIS OVERVIEW ---\n`; report += `Primary Topic: ${analysisSummary.topTopic}\n`; report += `Unique Entities (Salience > 0): ${analysisSummary.entityCount}\n`; report += `Avg. Salience (Top 10): ${analysisSummary.avgTopSalience}\n`; report += `Top Entity Dominance: ${analysisSummary.topEntityDominance}\n\n`; report += `--- CONTENT STRENGTH (GEMINI) ---\n`; report += `E-E-A-T Signals: ${contentStrength.eeatSignals.rating} - ${contentStrength.eeatSignals.justification}\n`; report += `Actionability: ${contentStrength.actionability.rating} - ${contentStrength.actionability.justification}\n`; report += `Clarity & Readability: ${contentStrength.clarity.rating} - ${contentStrength.clarity.justification}\n`; report += `Depth of Coverage: ${contentStrength.depth.rating} - ${contentStrength.depth.justification}\n\n`; report += `--- INTENT & FUNNEL (GEMINI) ---\n`; report += `User Intent: ${intentAnalysis.userIntent}\n`; report += `Funnel Stage: ${intentAnalysis.funnelStage}\n\n`; report += `--- KEY ENTITIES (JSON) ---\n`; (detected_entities || []).sort((a,b) => b.salience - a.salience).slice(0, 20).forEach(e => { const mentionCount = e.total_mentions_count ?? (e.unique_mentions_list || []).length; report += `- ${e.name} (${e.type}) - Salience: ${(e.salience || 0).toFixed(2)}, Mentions: ${mentionCount}\n`; }); report += `\n`; report += `--- DETECTED TOPICS (JSON) ---\n`; (detected_categories || []).forEach(c => { report += `- ${c.name} - Confidence: ${(c.confidence * 100).toFixed(1)}%\n`; }); try { const ta = document.createElement("textarea"); ta.value = report; ta.style.position="fixed"; ta.style.top="-9999px"; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); const btnTxt = exportBtn.textContent; exportBtn.textContent = 'Copied!'; setTimeout(() => { exportBtn.textContent = btnTxt; }, 2000); } catch (err) { console.error('Failed to copy: ', err); alert('Failed to copy.'); } }
        });
    </script>
</body>
</html>
